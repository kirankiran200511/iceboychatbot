<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ice-boy Support Chat</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary:        #2563eb;
      --primary-dark:   #1d4ed8;
      --primary-darker: #1e40af;
      --white:          #fff;
      --bg:             #f9fafb;
      --border:         #e5e7eb;
      --border-dark:    #d1d5db;
      --text:           #374151;
      --text-muted:     #6b7280;
      --text-light:     #9ca3af;
      --font: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
    }

    /* Transparent â€” only the widget floats, nothing else shows */
    html, body {
      width: 100%;
      height: 100%;
      background: transparent !important;
      font-family: var(--font);
      overflow: hidden;
    }

    /* Widget pinned bottom-right inside the iframe */
    #iceboy-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
    }

    /* Chat window â€” hidden by default */
    #iceboy-chat-window {
      width: 370px;
      height: 520px;
      border-radius: 16px;
      background: var(--white);
      box-shadow: 0 20px 60px rgba(0,0,0,0.18), 0 4px 16px rgba(37,99,235,0.12);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      opacity: 0;
      transform: scale(0.92) translateY(16px);
      transform-origin: bottom right;
      pointer-events: none;
      transition: opacity 0.22s ease, transform 0.22s ease;
    }

    #iceboy-chat-window.open {
      opacity: 1;
      transform: scale(1) translateY(0);
      pointer-events: all;
    }

    /* Header */
    .iceboy-chat-header {
      background: var(--primary);
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .iceboy-chat-header-left { display: flex; align-items: center; gap: 10px; }

    .iceboy-header-avatar {
      width: 38px; height: 38px;
      border-radius: 50%;
      background: rgba(255,255,255,0.18);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }

    .iceboy-title    { color: #fff; font-size: 1rem; font-weight: 600; }
    .iceboy-subtitle { color: rgba(255,255,255,0.72); font-size: 0.72rem; margin-top: 1px; }

    .iceboy-btn-close {
      background: transparent; border: none; cursor: pointer;
      color: rgba(255,255,255,0.85);
      width: 30px; height: 30px; border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s, color 0.15s;
    }
    .iceboy-btn-close:hover { background: rgba(255,255,255,0.15); color: #fff; }

    /* Messages body */
    .iceboy-chat-body {
      flex: 1; overflow-y: auto;
      padding: 1.1rem;
      background: var(--bg);
      display: flex; flex-direction: column;
      scroll-behavior: smooth;
    }
    .iceboy-chat-body::-webkit-scrollbar { width: 3px; }
    .iceboy-chat-body::-webkit-scrollbar-thumb { background: var(--border-dark); border-radius: 3px; }

    .iceboy-msg-row {
      display: flex; align-items: flex-end; gap: 7px;
      margin-bottom: 0.55rem;
      animation: msgIn 0.22s cubic-bezier(0.34,1.36,0.64,1) both;
    }
    @keyframes msgIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .iceboy-msg-row.bot  { justify-content: flex-start; }
    .iceboy-msg-row.user { justify-content: flex-end; }

    .iceboy-msg-avatar {
      width: 26px; height: 26px; border-radius: 50%;
      background: var(--primary);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }

    .iceboy-msg-col { display: flex; flex-direction: column; max-width: 80%; }
    .bot  .iceboy-msg-col { align-items: flex-start; }
    .user .iceboy-msg-col { align-items: flex-end; }

    .iceboy-bubble {
      padding: 0.7rem 0.875rem;
      border-radius: 12px;
      font-size: 0.9rem; line-height: 1.55;
      word-break: break-word;
    }
    .bot .iceboy-bubble {
      background: var(--white); color: var(--text);
      border: 1px solid var(--border);
      border-bottom-left-radius: 3px;
      white-space: pre-wrap;
    }
    .bot .iceboy-bubble a { color: var(--primary); text-decoration: underline; }
    .user .iceboy-bubble {
      background: var(--primary); color: #fff;
      border-bottom-right-radius: 3px;
    }

    /* Typing dots */
    .iceboy-typing-bubble {
      background: var(--white); border: 1px solid var(--border);
      padding: 0.75rem 0.875rem;
      border-radius: 12px; border-bottom-left-radius: 3px;
      display: flex; gap: 4px;
    }
    .iceboy-typing-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--text-muted);
      animation: bounce 1.1s infinite ease-in-out;
    }
    .iceboy-typing-dot:nth-child(2) { animation-delay: 0.18s; }
    .iceboy-typing-dot:nth-child(3) { animation-delay: 0.36s; }
    @keyframes bounce {
      0%,60%,100% { transform: translateY(0); }
      30%          { transform: translateY(-5px); }
    }

    /* Footer */
    .iceboy-chat-footer {
      background: var(--white);
      padding: 0.65rem 0.875rem 0.8rem;
      border-top: 1px solid #f0f0f0;
      flex-shrink: 0;
    }
    .iceboy-footer-powered {
      text-align: center; font-size: 0.65rem;
      color: var(--text-light); margin-bottom: 0.45rem;
    }
    .iceboy-input-wrap {
      display: flex; align-items: flex-end; gap: 6px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 0.4rem 0.55rem;
      transition: border-color 0.15s;
    }
    .iceboy-input-wrap:focus-within { border-color: var(--primary); }

    #iceboy-textarea {
      flex: 1; border: none; background: transparent;
      font-size: 0.9rem; font-family: var(--font);
      color: var(--text); outline: none; resize: none;
      min-height: 20px; max-height: 100px;
      line-height: 1.5; padding: 2px 0;
    }
    #iceboy-textarea::placeholder { color: var(--text-light); }

    .iceboy-btn-send {
      background: var(--primary); border: none; cursor: pointer;
      color: #fff; width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: all 0.15s;
    }
    .iceboy-btn-send:hover   { background: var(--primary-dark); }
    .iceboy-btn-send:active  { transform: scale(0.92); }
    .iceboy-btn-send:disabled { background: #93c5fd; cursor: not-allowed; }

    /* Toggle button */
    #iceboy-toggle {
      width: 58px; height: 58px; border-radius: 50%;
      background: var(--primary); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 8px 28px rgba(37,99,235,0.45);
      transition: background 0.15s, transform 0.15s;
      flex-shrink: 0;
    }
    #iceboy-toggle:hover  { background: var(--primary-dark); transform: scale(1.06); }
    #iceboy-toggle:active { transform: scale(0.97); }

    /* Icon swap */
    .icon-chat  { display: block; }
    .icon-close { display: none; }
    #iceboy-toggle.open .icon-chat  { display: none; }
    #iceboy-toggle.open .icon-close { display: block; }
  </style>
</head>
<body>

  <div id="iceboy-widget">

    <!-- Chat window (starts hidden) -->
    <div id="iceboy-chat-window" role="dialog" aria-label="Ice-boy Support Chat">

      <div class="iceboy-chat-header">
        <div class="iceboy-chat-header-left">
          <div class="iceboy-header-avatar">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                 fill="none" stroke="white" stroke-width="2" stroke-linecap="round">
              <line x1="12" y1="2"  x2="12" y2="22"/>
              <line x1="2"  y1="12" x2="22" y2="12"/>
              <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
              <line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/>
              <line x1="12" y1="2"  x2="9"  y2="5"/> <line x1="12" y1="2"  x2="15" y2="5"/>
              <line x1="12" y1="22" x2="9"  y2="19"/><line x1="12" y1="22" x2="15" y2="19"/>
              <line x1="2"  y1="12" x2="5"  y2="9"/> <line x1="2"  y1="12" x2="5"  y2="15"/>
              <line x1="22" y1="12" x2="19" y2="9"/> <line x1="22" y1="12" x2="19" y2="15"/>
            </svg>
          </div>
          <div>
            <div class="iceboy-title">Ice-boy Support</div>
            <div class="iceboy-subtitle">AI Assistant &bull; 33+ Years of Excellence</div>
          </div>
        </div>
        <button class="iceboy-btn-close" id="iceboy-btn-close" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <line x1="18" y1="6"  x2="6"  y2="18"/>
            <line x1="6"  y1="6"  x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="iceboy-chat-body" id="iceboy-chat-body"></div>

      <div class="iceboy-chat-footer">
        <div class="iceboy-footer-powered">Powered by Ice-boy AI Assistant</div>
        <div class="iceboy-input-wrap">
          <textarea id="iceboy-textarea" rows="1" placeholder="Type your messageâ€¦"></textarea>
          <button class="iceboy-btn-send" id="iceboy-btn-send" aria-label="Send">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                 fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Floating toggle button -->
    <button id="iceboy-toggle" aria-label="Open chat">
      <svg class="icon-chat" xmlns="http://www.w3.org/2000/svg" width="26" height="26"
           viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round">
        <line x1="12" y1="2"  x2="12" y2="22"/>
        <line x1="2"  y1="12" x2="22" y2="12"/>
        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
        <line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/>
        <line x1="12" y1="2"  x2="9"  y2="5"/> <line x1="12" y1="2"  x2="15" y2="5"/>
        <line x1="12" y1="22" x2="9"  y2="19"/><line x1="12" y1="22" x2="15" y2="19"/>
        <line x1="2"  y1="12" x2="5"  y2="9"/> <line x1="2"  y1="12" x2="5"  y2="15"/>
        <line x1="22" y1="12" x2="19" y2="9"/> <line x1="22" y1="12" x2="19" y2="15"/>
      </svg>
      <svg class="icon-close" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
           viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round">
        <line x1="18" y1="6"  x2="6"  y2="18"/>
        <line x1="6"  y1="6"  x2="18" y2="18"/>
      </svg>
    </button>

  </div>

  <script>
  (function () {
    'use strict';

    const WEBHOOK_URL = 'https://n8n.srv1178999.hstgr.cloud/webhook/680058b4-c36b-491f-b676-ebaeddbf7026/chat';

    let webhookUrl = WEBHOOK_URL;
    let sessionId  = getSessionId();
    let isTyping   = false;
    let isOpen     = false;
    let welcomed   = false;

    const chatWindow = document.getElementById('iceboy-chat-window');
    const chatBody   = document.getElementById('iceboy-chat-body');
    const textarea   = document.getElementById('iceboy-textarea');
    const sendBtn    = document.getElementById('iceboy-btn-send');
    const closeBtn   = document.getElementById('iceboy-btn-close');
    const toggleBtn  = document.getElementById('iceboy-toggle');

    window.addEventListener('message', function (e) {
      if (e.data && e.data.webhookUrl) webhookUrl = e.data.webhookUrl;
    });

    toggleBtn.addEventListener('click', function () { isOpen ? close() : open(); });
    closeBtn.addEventListener('click', close);

    textarea.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });
    sendBtn.addEventListener('click', send);

    textarea.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    function open() {
      isOpen = true;
      chatWindow.classList.add('open');
      toggleBtn.classList.add('open');
      textarea.focus();
      scrollBottom();
      if (!welcomed) {
        welcomed = true;
        setTimeout(function () { addMessage('bot', 'Hello! Welcome to Ice-boy India ðŸ§Š'); }, 300);
        setTimeout(function () { addMessage('bot', 'How can I help you today?'); }, 950);
      }
    }

    function close() {
      isOpen = false;
      chatWindow.classList.remove('open');
      toggleBtn.classList.remove('open');
    }

    async function send() {
      const text = textarea.value.trim();
      if (!text || isTyping) return;

      addMessage('user', text);
      textarea.value = '';
      textarea.style.height = 'auto';
      sendBtn.disabled = true;
      isTyping = true;
      showTyping();

      try {
        const res = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ chatInput: text, sessionId: sessionId })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        hideTyping();

        let reply = '';
        if (typeof data === 'string') reply = data;
        else if (Array.isArray(data)) reply = data[0]?.output || data[0]?.text || data[0]?.message || '';
        else reply = data?.output || data?.text || data?.message || data?.reply || data?.response || data?.answer || '';

        addMessage('bot', reply || 'Message received!');
      } catch (err) {
        hideTyping();
        addMessage('bot', 'Sorry, I could not reach the server. Please try again.');
      } finally {
        sendBtn.disabled = false;
        isTyping = false;
      }
    }

    function addMessage(role, text) {
      const row = document.createElement('div');
      row.className = 'iceboy-msg-row ' + role;
      const content = role === 'bot' ? formatBot(text) : escapeHtml(text);
      row.innerHTML = role === 'bot'
        ? '<div class="iceboy-msg-avatar">' + flake(12) + '</div><div class="iceboy-msg-col"><div class="iceboy-bubble">' + content + '</div></div>'
        : '<div class="iceboy-msg-col"><div class="iceboy-bubble">' + content + '</div></div>';
      chatBody.appendChild(row);
      scrollBottom();
    }

    function showTyping() {
      const row = document.createElement('div');
      row.className = 'iceboy-msg-row bot'; row.id = 'iceboy-typing';
      row.innerHTML = '<div class="iceboy-msg-avatar">' + flake(12) + '</div>' +
        '<div class="iceboy-typing-bubble"><div class="iceboy-typing-dot"></div><div class="iceboy-typing-dot"></div><div class="iceboy-typing-dot"></div></div>';
      chatBody.appendChild(row); scrollBottom();
    }

    function hideTyping() { const el = document.getElementById('iceboy-typing'); if (el) el.remove(); }

    function scrollBottom() { requestAnimationFrame(function () { chatBody.scrollTop = chatBody.scrollHeight; }); }

    function getSessionId() {
      const k = 'iceboy_session'; let id;
      try { id = localStorage.getItem(k); } catch(e) {}
      if (!id) { id = 'sess_' + Math.random().toString(36).slice(2,11) + Date.now().toString(36); try { localStorage.setItem(k, id); } catch(e) {} }
      return id;
    }

    function escapeHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function formatBot(text) {
      const links = [];
      let out = text.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, function(_,lt,url){ links.push({text:lt,url}); return '###L'+(links.length-1)+'###'; });
      out = escapeHtml(out);
      links.forEach(function(l,i){ out = out.replace('###L'+i+'###','<a href="'+l.url.replace(/"/g,'&quot;')+'" target="_blank" rel="noopener noreferrer">'+escapeHtml(l.text)+'</a>'); });
      return out;
    }

    function flake(size) {
      return '<svg xmlns="http://www.w3.org/2000/svg" width="'+size+'" height="'+size+'" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round">' +
        '<line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/>' +
        '<line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/><line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/>' +
        '<line x1="12" y1="2" x2="9" y2="5"/><line x1="12" y1="2" x2="15" y2="5"/>' +
        '<line x1="12" y1="22" x2="9" y2="19"/><line x1="12" y1="22" x2="15" y2="19"/>' +
        '<line x1="2" y1="12" x2="5" y2="9"/><line x1="2" y1="12" x2="5" y2="15"/>' +
        '<line x1="22" y1="12" x2="19" y2="9"/><line x1="22" y1="12" x2="19" y2="15"/></svg>';
    }
  })();
  </script>
</body>
</html>
