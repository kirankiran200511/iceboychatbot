<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ice-boy Support Chat</title>
  <style>
    /* â”€â”€ Reset â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --iceboy-primary:        #2563eb;
      --iceboy-primary-dark:   #1d4ed8;
      --iceboy-primary-darker: #1e40af;
      --iceboy-white:          #fff;
      --iceboy-bg:             #f9fafb;
      --iceboy-border:         #e5e7eb;
      --iceboy-border-dark:    #d1d5db;
      --iceboy-text:           #374151;
      --iceboy-text-muted:     #6b7280;
      --iceboy-text-light:     #9ca3af;
      --iceboy-font: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: var(--iceboy-font);
    }

    /* â”€â”€ Full-page chat layout â”€â”€ */
    #iceboy-chat-window {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
      width: 100%;
      background: var(--iceboy-white);
    }

    /* Header */
    .iceboy-chat-header {
      background: var(--iceboy-primary);
      padding: 1rem 1.375rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .iceboy-chat-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .iceboy-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .iceboy-header-info .iceboy-title {
      color: #fff;
      font-size: 1.0625rem;
      font-weight: 600;
      line-height: 1.3;
    }

    .iceboy-header-info .iceboy-subtitle {
      color: rgba(255,255,255,0.75);
      font-size: 0.75rem;
      margin-top: 1px;
    }

    /* Messages Body */
    .iceboy-chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.25rem;
      background: var(--iceboy-bg);
      display: flex;
      flex-direction: column;
      gap: 0;
      scroll-behavior: smooth;
    }

    .iceboy-chat-body::-webkit-scrollbar { width: 4px; }
    .iceboy-chat-body::-webkit-scrollbar-track { background: transparent; }
    .iceboy-chat-body::-webkit-scrollbar-thumb { background: var(--iceboy-border-dark); border-radius: 4px; }

    /* Message Rows */
    .iceboy-msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      margin-bottom: 0.625rem;
      animation: iceboyMsgIn 0.22s cubic-bezier(0.34,1.36,0.64,1) both;
    }

    @keyframes iceboyMsgIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .iceboy-msg-row.bot  { justify-content: flex-start; }
    .iceboy-msg-row.user { justify-content: flex-end; }

    .iceboy-msg-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--iceboy-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .iceboy-msg-col {
      display: flex;
      flex-direction: column;
      max-width: 78%;
    }

    .bot  .iceboy-msg-col { align-items: flex-start; }
    .user .iceboy-msg-col { align-items: flex-end; }

    .iceboy-bubble {
      padding: 0.8125rem 0.9375rem;
      border-radius: 0.75rem;
      font-size: 0.9375rem;
      line-height: 1.55;
      word-break: break-word;
    }

    .bot .iceboy-bubble {
      background: var(--iceboy-white);
      color: var(--iceboy-text);
      border: 1px solid var(--iceboy-border);
      border-bottom-left-radius: 4px;
      white-space: pre-wrap;
    }

    .bot .iceboy-bubble a { color: var(--iceboy-primary); text-decoration: underline; word-break: break-all; }
    .bot .iceboy-bubble a:hover { color: var(--iceboy-primary-dark); }

    .user .iceboy-bubble {
      background: var(--iceboy-primary);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    /* Typing indicator */
    .iceboy-typing-bubble {
      background: var(--iceboy-white);
      border: 1px solid var(--iceboy-border);
      padding: 0.875rem 1rem;
      border-radius: 0.75rem;
      border-bottom-left-radius: 4px;
      display: flex;
      gap: 4px;
    }

    .iceboy-typing-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--iceboy-text-muted);
      animation: iceboyBounce 1.1s infinite ease-in-out;
    }

    .iceboy-typing-dot:nth-child(2) { animation-delay: 0.18s; }
    .iceboy-typing-dot:nth-child(3) { animation-delay: 0.36s; }

    @keyframes iceboyBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30%            { transform: translateY(-5px); }
    }

    /* Footer */
    .iceboy-chat-footer {
      background: var(--iceboy-white);
      padding: 0.75rem 1rem 0.875rem;
      flex-shrink: 0;
      border-top: 1px solid #f0f0f0;
      padding-bottom: max(0.875rem, env(safe-area-inset-bottom));
    }

    .iceboy-footer-powered {
      text-align: center;
      font-size: 0.6875rem;
      color: var(--iceboy-text-light);
      margin-bottom: 0.5rem;
    }

    .iceboy-input-wrap {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      background: var(--iceboy-bg);
      border: 1px solid var(--iceboy-border);
      border-radius: 1.5rem;
      padding: 0.45rem 0.625rem;
      transition: border-color 0.15s;
    }

    .iceboy-input-wrap:focus-within { border-color: var(--iceboy-primary); }

    #iceboy-chat-textarea {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 0.9375rem;
      font-family: var(--iceboy-font);
      color: var(--iceboy-text);
      outline: none;
      resize: none;
      min-height: 22px;
      max-height: 120px;
      line-height: 1.5;
      padding: 3px 0;
    }

    #iceboy-chat-textarea::placeholder { color: var(--iceboy-text-light); }

    .iceboy-btn-send {
      background: var(--iceboy-primary);
      border: none;
      cursor: pointer;
      color: #fff;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }

    .iceboy-btn-send:hover   { background: var(--iceboy-primary-dark); }
    .iceboy-btn-send:active  { transform: scale(0.93); }
    .iceboy-btn-send:disabled { background: #93c5fd; cursor: not-allowed; }
  </style>
</head>
<body>

  <div id="iceboy-chat-window" role="dialog" aria-label="Ice-boy Support Chat">

    <!-- Header -->
    <div class="iceboy-chat-header">
      <div class="iceboy-chat-header-left">
        <div class="iceboy-header-avatar">
          <!-- Snowflake icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
               fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="2"  x2="12" y2="22"/>
            <line x1="2"  y1="12" x2="22" y2="12"/>
            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
            <line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/>
            <line x1="12" y1="2"  x2="9"  y2="5"/> <line x1="12" y1="2"  x2="15" y2="5"/>
            <line x1="12" y1="22" x2="9"  y2="19"/><line x1="12" y1="22" x2="15" y2="19"/>
            <line x1="2"  y1="12" x2="5"  y2="9"/> <line x1="2"  y1="12" x2="5"  y2="15"/>
            <line x1="22" y1="12" x2="19" y2="9"/> <line x1="22" y1="12" x2="19" y2="15"/>
          </svg>
        </div>
        <div class="iceboy-header-info">
          <div class="iceboy-title">Ice-boy Support</div>
          <div class="iceboy-subtitle">AI Assistant &bull; 33+ Years of Excellence</div>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div class="iceboy-chat-body" id="iceboy-chat-body"></div>

    <!-- Input Footer -->
    <div class="iceboy-chat-footer">
      <div class="iceboy-footer-powered">Powered by Ice-boy AI Assistant</div>
      <div class="iceboy-input-wrap">
        <textarea id="iceboy-chat-textarea" rows="1"
                  placeholder="Type your messageâ€¦"
                  aria-label="Message input"></textarea>
        <button class="iceboy-btn-send" id="iceboy-btn-send"
                title="Send" aria-label="Send message">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2.5"
               stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      'use strict';

      // â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // The webhook URL can be overridden by the parent page via postMessage:
      //   iframe.contentWindow.postMessage({ webhookUrl: 'https://â€¦' }, '*');
      // Or set WEBHOOK_URL below directly.
      const WEBHOOK_URL =
        'https://n8n.srv1178999.hstgr.cloud/webhook/680058b4-c36b-491f-b676-ebaeddbf7026/chat';

      // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let webhookUrl = WEBHOOK_URL;
      let sessionId  = getSessionId();
      let isTyping   = false;

      // â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const body     = document.getElementById('iceboy-chat-body');
      const textarea = document.getElementById('iceboy-chat-textarea');
      const sendBtn  = document.getElementById('iceboy-btn-send');

      // Allow parent to override webhook URL dynamically
      window.addEventListener('message', function (e) {
        if (e.data && e.data.webhookUrl) {
          webhookUrl = e.data.webhookUrl;
        }
      });

      // Send on Enter (Shift+Enter = new line)
      textarea.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      sendBtn.addEventListener('click', sendMessage);

      // Auto-grow textarea
      textarea.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // Welcome message
      setTimeout(function () {
        addMessage('bot', 'Hello! Welcome to Ice-boy India ðŸ§Š\nHow can I help you today?');
      }, 400);

      // â”€â”€ FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      function addMessage(role, text) {
        const row = document.createElement('div');
        row.className = 'iceboy-msg-row ' + role;

        let html = '';
        if (role === 'bot') {
          html =
            '<div class="iceboy-msg-avatar">' + snowflakeSVG(13) + '</div>' +
            '<div class="iceboy-msg-col">' +
              '<div class="iceboy-bubble">' + formatBot(text) + '</div>' +
            '</div>';
        } else {
          html =
            '<div class="iceboy-msg-col">' +
              '<div class="iceboy-bubble">' + escapeHtml(text) + '</div>' +
            '</div>';
        }

        row.innerHTML = html;
        body.appendChild(row);
        scrollBottom();
      }

      function showTyping() {
        const row = document.createElement('div');
        row.className = 'iceboy-msg-row bot';
        row.id = 'iceboy-typing-row';
        row.innerHTML =
          '<div class="iceboy-msg-avatar">' + snowflakeSVG(13) + '</div>' +
          '<div class="iceboy-typing-bubble">' +
            '<div class="iceboy-typing-dot"></div>' +
            '<div class="iceboy-typing-dot"></div>' +
            '<div class="iceboy-typing-dot"></div>' +
          '</div>';
        body.appendChild(row);
        scrollBottom();
      }

      function hideTyping() {
        const el = document.getElementById('iceboy-typing-row');
        if (el) el.remove();
      }

      async function sendMessage() {
        const text = textarea.value.trim();
        if (!text || isTyping) return;

        addMessage('user', text);
        textarea.value = '';
        textarea.style.height = 'auto';
        sendBtn.disabled = true;
        isTyping = true;
        showTyping();

        try {
          const res = await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ chatInput: text, sessionId: sessionId })
          });

          if (!res.ok) throw new Error('HTTP ' + res.status);

          const data = await res.json();
          hideTyping();

          let reply = '';
          if (typeof data === 'string') {
            reply = data;
          } else if (Array.isArray(data)) {
            reply = data[0]?.output || data[0]?.text || data[0]?.message || JSON.stringify(data[0]);
          } else {
            reply = data?.output || data?.text || data?.message
              || data?.reply || data?.response || data?.answer
              || (data?.data && (data.data?.output || data.data?.text))
              || JSON.stringify(data);
          }

          addMessage('bot', reply || 'Message received!');

        } catch (err) {
          hideTyping();
          console.error('Ice-boy Chat error:', err);
          addMessage('bot', 'Sorry, I could not reach the server. Please try again.');
        } finally {
          sendBtn.disabled = false;
          isTyping = false;
        }
      }

      function scrollBottom() {
        requestAnimationFrame(function () { body.scrollTop = body.scrollHeight; });
      }

      function getSessionId() {
        const key = 'iceboy_session';
        let id = null;
        try { id = localStorage.getItem(key); } catch (e) {}
        if (!id) {
          id = 'sess_' + Math.random().toString(36).slice(2, 11) + Date.now().toString(36);
          try { localStorage.setItem(key, id); } catch (e) {}
        }
        return id;
      }

      function escapeHtml(s) {
        return s
          .replace(/&/g,  '&amp;')
          .replace(/</g,  '&lt;')
          .replace(/>/g,  '&gt;')
          .replace(/"/g,  '&quot;')
          .replace(/'/g,  '&#39;');
      }

      function formatBot(text) {
        const links = [];
        let out = text.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, function (_, lt, url) {
          links.push({ text: lt, url: url });
          return '###LINK' + (links.length - 1) + '###';
        });
        out = escapeHtml(out);
        links.forEach(function (link, i) {
          out = out.replace(
            '###LINK' + i + '###',
            '<a href="' + link.url.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener noreferrer">' +
            escapeHtml(link.text) + '</a>'
          );
        });
        return out;
      }

      function snowflakeSVG(size) {
        return '<svg xmlns="http://www.w3.org/2000/svg" width="' + size + '" height="' + size + '" ' +
          'viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" ' +
          'stroke-linecap="round" stroke-linejoin="round">' +
          '<line x1="12" y1="2"  x2="12" y2="22"/>' +
          '<line x1="2"  y1="12" x2="22" y2="12"/>' +
          '<line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>' +
          '<line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/>' +
          '<line x1="12" y1="2"  x2="9"  y2="5"/> <line x1="12" y1="2"  x2="15" y2="5"/>' +
          '<line x1="12" y1="22" x2="9"  y2="19"/><line x1="12" y1="22" x2="15" y2="19"/>' +
          '<line x1="2"  y1="12" x2="5"  y2="9"/> <line x1="2"  y1="12" x2="5"  y2="15"/>' +
          '<line x1="22" y1="12" x2="19" y2="9"/> <line x1="22" y1="12" x2="19" y2="15"/>' +
          '</svg>';
      }

    })();
  </script>

</body>
</html>
